{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <h2 class="text-center mb-3">{{ player['name'] }} ì„ ìˆ˜ ìƒì„¸ í˜ì´ì§€</h2>
  <p class="text-center text-muted">
    íŒ€: {{ player['team'] or '-' }} | í¬ì§€ì…˜: {{ player['position'] or '-' }}
  </p>

  {% if is_admin %}
  <div class="text-center mb-3">
    <a href="{{ url_for('edit_player', player_id=player.id) }}" class="btn btn-warning btn-sm">âœï¸ ì„ ìˆ˜ ìˆ˜ì •</a>
    <form action="{{ url_for('delete_player', player_id=player.id) }}" method="POST" style="display:inline;">
      <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">ğŸ—‘ï¸ ì„ ìˆ˜ ì‚­ì œ</button>
    </form>
  </div>
  {% endif %}

  <hr>

  <div class="row mt-4">
    <!-- íƒ€ê²© ìš”ì•½ -->
    <div class="col-md-6">
      <h4 class="mb-2">âš¾ íƒ€ê²© í†µê³„</h4>
      <ul class="list-group mb-3">
        <li class="list-group-item">íƒ€ìˆ˜(AB): {{ totals_b['ab'] }}</li>
        <li class="list-group-item">ì•ˆíƒ€(H): {{ totals_b['hits'] }}</li>
        <li class="list-group-item">í™ˆëŸ°(HR): {{ totals_b['hr'] }}</li>
        <li class="list-group-item">íƒ€ì (RBI): {{ totals_b['rbi'] }}</li>
        <li class="list-group-item"><strong>íƒ€ìœ¨(AVG): {{ "%.3f"|format(agg_avg) }}</strong></li>
      </ul>
      <canvas id="batChart" height="150"></canvas>
    </div>

    <!-- íˆ¬ìˆ˜ ìš”ì•½ -->
    <div class="col-md-6">
      <h4 class="mb-2">ğŸ¥ íˆ¬ìˆ˜ í†µê³„</h4>
      <ul class="list-group mb-3">
        <li class="list-group-item">ì´ë‹(IP): {{ totals_p['inn'] }}</li>
        <li class="list-group-item">ìì±…ì (ER): {{ totals_p['er'] }}</li>
        <li class="list-group-item">ì‚¼ì§„(SO): {{ totals_p['so'] }}</li>
        <li class="list-group-item">ë³¼ë„·(BB): {{ totals_p['bb'] }}</li>
        <li class="list-group-item"><strong>ERA: {{ "%.2f"|format(agg_era) }}</strong></li>
      </ul>
      <canvas id="pitChart" height="150"></canvas>
    </div>
  </div>

  <hr class="mt-4">

  <!-- íƒ€ê²© ê¸°ë¡ í…Œì´ë¸” -->
  <h4 class="mt-4">ğŸ“‹ íƒ€ê²© ê¸°ë¡</h4>
  <table class="table table-striped">
    <thead>
      <tr>
        <th>ë‚ ì§œ</th>
        <th>ê²½ê¸°</th>
        <th>AB</th>
        <th>H</th>
        <th>HR</th>
        <th>RBI</th>
        <th>íƒ€ìœ¨</th>
        {% if is_admin %}<th>ê´€ë¦¬</th>{% endif %}
      </tr>
    </thead>
    <tbody>
      {% for b in batting %}
      <tr>
        <td>
          {% if b['game_date'] %}
            {{ b['game_date'] }}
          {% else %}
            {{ b['created_at']|string[:10] }}
          {% endif %}
        </td>
        <td>{{ b['game_name'] or '-' }}</td>
        <td>{{ b['ab'] }}</td>
        <td>{{ b['hits'] }}</td>
        <td>{{ b['hr'] }}</td>
        <td>{{ b['rbi'] }}</td>
        <td>{{ "%.3f"|format(b['per_game_avg']) }}</td>

        {% if is_admin %}
        <td>
          <a href="{{ url_for('edit_batting', record_id=b['id']) }}" class="btn btn-sm btn-warning">ìˆ˜ì •</a>
        </td>
        {% endif %}
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- íˆ¬ìˆ˜ ê¸°ë¡ í…Œì´ë¸” -->
  <h4 class="mt-4">ğŸ“Š íˆ¬ìˆ˜ ê¸°ë¡</h4>
  <table class="table table-striped">
    <thead>
      <tr>
        <th>ë‚ ì§œ</th>
        <th>ê²½ê¸°</th>
        <th>IP</th>
        <th>ER</th>
        <th>SO</th>
        <th>BB</th>
        <th>ERA</th>
        {% if is_admin %}<th>ê´€ë¦¬</th>{% endif %}
      </tr>
    </thead>
    <tbody>
      {% for p in pitching %}
      <tr>
        <td>
          {% if p['game_date'] %}
            {{ p['game_date'] }}
          {% else %}
            {{ p['created_at']|string[:10] }}
          {% endif %}
        </td>
        <td>{{ p['game_name'] or '-' }}</td>
        <td>{{ p['innings'] }}</td>
        <td>{{ p['er'] }}</td>
        <td>{{ p['so'] }}</td>
        <td>{{ p['bb'] }}</td>
        <td>{{ "%.2f"|format(p['per_game_era']) }}</td>

        {% if is_admin %}
        <td>
          <a href="{{ url_for('edit_pitching', record_id=p['id']) }}" class="btn btn-sm btn-warning">ìˆ˜ì •</a>
        </td>
        {% endif %}
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <div class="mt-4 text-center">
    <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">â† í™ˆìœ¼ë¡œ</a>
  </div>
</div>

<!-- ê·¸ë˜í”„ ìŠ¤í¬ë¦½íŠ¸ -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const batCtx = document.getElementById('batChart');
const pitCtx = document.getElementById('pitChart');

// íƒ€ê²© ê·¸ë˜í”„
new Chart(batCtx, {
  type: 'line',
  data: {
    labels: {{ b_labels|tojson }},
    datasets: [
      {
        label: 'ê²½ê¸°ë³„ íƒ€ìœ¨',
        data: {{ b_avg_series|tojson }},
        borderColor: '#2b6cb0',
        tension: 0.3,
        fill: false
      },
      {
        label: 'ëˆ„ì  HR',
        data: {{ b_hr_series|tojson }},
        borderColor: '#d9534f',
        borderDash: [5,5],
        tension: 0.3,
        fill: false
      },
      {
        label: 'ëˆ„ì  RBI',
        data: {{ b_rbi_series|tojson }},
        borderColor: '#5cb85c',
        borderDash: [2,2],
        tension: 0.3,
        fill: false
      }
    ]
  },
  options: {
    plugins: { legend: { position: 'bottom' } },
    scales: { y: { beginAtZero: true } }
  }
});

// íˆ¬ìˆ˜ ê·¸ë˜í”„
new Chart(pitCtx, {
  type: 'line',
  data: {
    labels: {{ p_labels|tojson }},
    datasets: [
      {
        label: 'ê²½ê¸°ë³„ ERA',
        data: {{ p_era_series|tojson }},
        borderColor: '#ff9900',
        tension: 0.3,
        fill: false
      },
      {
        label: 'ëˆ„ì  SO',
        data: {{ p_k_series|tojson }},
        borderColor: '#007bff',
        borderDash: [4,4],
        tension: 0.3,
        fill: false
      },
      {
        label: 'ëˆ„ì  IP',
        data: {{ p_ip_series|tojson }},
        borderColor: '#00a676',
        borderDash: [3,3],
        tension: 0.3,
        fill: false
      }
    ]
  },
  options: {
    plugins: { legend: { position: 'bottom' } },
    scales: { y: { beginAtZero: true } }
  }
});
</script>
{% endblock %}
